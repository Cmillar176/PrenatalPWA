<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<dom-module id="my-notes">
    <template>
        <style>
            h1 {
                color: #7E57C2;
                font-size: 23px;
                font-weight: normal;
                margin-left: 40px;
            }
            
            paper-card {
                width: 600px;
                margin-left: 40px;
                margin-bottom:30px;
                padding-left: 10px;
                padding-right: 10px;
                padding-bottom: 10px;
                z-index: 30px;
            }
            
            paper-button {
                background-color: #42A5F5;
                color: white;
                font-size: 13px;
            }
            
            paper-button:hover {
                background-color: #64B5F6;
            }
            
            confirmDeleteModal {
                z-index: 10px;
            }
            
            #notes-controls {
                padding-top: 20px;
            }
            
            #appointmentDate {
                width: 200px;
            }
            
            #gestationDate {
                width: 200px;
            }
            
            #add-note {
                width: 500px;
            }
            
            #patient-info {
                padding-top: 20px;
            }
            
            #bloodPressure {
                width: 162px;
            }
            
            #gestationWeeks {
                width: 120px;
            }
            
            #gestationDays {
                width: 110px;
            }
        </style>
        <firebase-auth app-name="PrenatalPWA" user="{{user}}"></firebase-auth>
        <firebase-query id="query" order-by-child="noteStatus" equal-to="saved" app-name="PrenatalPWA" path="/users/[[user.uid]]/notes" data="{{notes}}"> </firebase-query>
        <app-indexeddb-mirror session="[[user.uid]]" key="notes" data="{{notes}}" persisted-data="{{persistedNotes}}"> </app-indexeddb-mirror>
        <h1>My Notes</h1>
        <paper-dialog id="confirmDeleteModal" opened="{{noteToDelete}}">
            <p>Are you sure you want to delete this note?</p>
            <div class="buttons">
                <paper-button autofocus on-tap="closeModal">Cancel</paper-button>
                <paper-button on-tap="confirmDelete">Delete</paper-button>
            </div>
        </paper-dialog>
        <template is="dom-repeat" items="[[persistedNotes]]" as="note">
            <paper-card status="{{noteStatus}}">
                <p class="date">Appointment date: [[note.appointmentDate]]</p>
                <p class="content">Appointment details: [[note.content]]</p>
                <paper-button raised on-tap="_directToView">View note</paper-button>
                <paper-button raised on-tap="openModal">Delete</paper-button>
            </paper-card>
        </template>
    </template>
    <script>
        Polymer({
            is: 'my-notes'
            , properties: {
                noteToDelete: {
                    type: String
                    , value: ""
                }
                , noteStatus: {
                    type: String
                    , value: 'saved'
                    , notify: true
                }
            , }
            , openModal: function (e) {
                this.noteToDelete = e.model.note;
            }
            , closeModal: function () {
                this.noteToDelete = "";
            }
            , _directToView: function (e) {
                var id = e.model.note.$key;
                window.history.pushState({}, null, '/view-note/' + id);
                window.dispatchEvent(new CustomEvent('location-changed'));
            }
            , confirmDelete: function (e) {
                if (this.noteToDelete) {
                    var deleteID = this.noteToDelete.$key
                    this.$.query.ref.child(deleteID).update({
                        "noteStatus": 'deleted'
                    });
                }
                this.closeModal();
            }
        });
    </script>
</dom-module>