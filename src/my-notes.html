<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="manifest" href="/manifest.json">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="my-icons.html">
<dom-module id="my-notes">
    <template>
        <style>
            paper-card {
                width: 600px;
                margin-top: 40px;
                margin-left: 40px;
                padding-left: 10px;
                padding-right: 10px;
                padding-bottom: 10px;
                z-index: 30px;
            }
            
            paper-button {
                background-color: #9575CD;
                color: white;
                font-size: 12px;
            }
            
            #private {
                background-color: #EF5350;
                float: right;
            }
            
            #notes-controls {
                padding-top: 20px;
            }
            
            #appointmentDate {
                width: 200px;
            }
            
            #gestationDate {
                width: 200px;
            }
            
            #add-note {
                width: 500px;
            }
            
            #patient-info {
                padding-top: 20px;
            }
            
            #bloodPressure {
                width: 120px;
            }
            
            #gestationWeeks {
                width: 120px;
            }
            
            #gestationDays {
                width: 110px;
            }
            
            #checkboxContainer {
                @apply(--layout-vertical);
                --paper-checkbox-checked-color: #7E57C2;
                display: inline-block;
                padding: 0 0 0 0px;
                /*
                display: inline-flex;
                vertical-align: var(--paper-checkbox-vertical-align, middle);
*/
            }
        </style>
        <firebase-auth app-name="PrenatalPWA" user="{{user}}"></firebase-auth>
        <!--        Lets us talk to firebase DB-->
        <firebase-query id="query" app-name="PrenatalPWA" path="/users/[[user.uid]]/notes" data="{{notes}}"> </firebase-query>
        <app-indexeddb-mirror session="[[user.uid]]" key="notes" data="{{notes}}" persisted-data="{{persistedNotes}}"> </app-indexeddb-mirror>
        <paper-card class="details">
            <div id="appointment-details">
                <vaadin-date-picker id="appointmentDate" label="Date of appointment" value="{{newNote.appointmentDate}}"> </vaadin-date-picker>
                <paper-input id="gestationWeeks" maxlength="2" label="Gestation" type="number" value="{{newNote.gestationWeeks}}">
                    <div suffix>Weeks</div>
                </paper-input>
                <paper-input id="gestationDays" maxlength="2" label="Gestation" type="number" value="{{newNote.gestationDays}}">
                    <div suffix>Days</div>
                </paper-input>
                <!--            <vaadin-date-picker id="gestationDate" label="Beginning of gestation"> </vaadin-date-picker>-->
                <paper-input maxlength="6" id="bloodPressure" value="{{newNote.bloodPressure}}" label="Blood pressure"></paper-input>
                <!--                TODO Align checkboxes-->
                <div id="checkboxContainer">
                    <paper-checkbox id="movementFelt" checked="{{newNote.movementFelt}}"> Fetal movement felt?</paper-checkbox>
                    <paper-checkbox id="movementDiscussed" checked="{{newNote.movementDiscussed}}"> Fetal movement discussed?</paper-checkbox>
                    <paper-checkbox id="healthDiscussed" class="select" checked="{{newNote.healthDiscussed}}"> Mental health and wellbeing discussed?</paper-checkbox>
                </div>
            </div>
            <div id="add-note">
                <paper-input id="input" label="Add appointment details" value="{{newNote.content}}"></paper-input>
            </div>
            <div id="notes-controls">
                <paper-button raised id="add" on-tap="add">Add</paper-button>
            </div>
        </paper-card>
        <template is="dom-repeat" items="[[persistedNotes]]" as="note">
            <paper-card>
                <p class="date">Appointment date: [[note.appointmentDate]]</p>
                <p class="gestationWeeks">Gestation weeks: [[note.gestationWeeks]]</p>
                <p class="gestationDays">Gestation days: [[note.gestationDays]]</p>
                <p class="movementFelt">Fetal movement felt: [[note.movementFelt]]</p>
                <p class="movementDiscussed">Fetal movement discussed: [[note.movementDiscussed]]</p>
                <p class="healthDiscussed">Mental health and wellbeing discussed: [[note.healthDiscussed]]</p>
                <p class="bloodPressure">Blood pressure: [[note.bloodPressure]]</p>
                <p class="content">Appointment details: [[note.content]]</p>
                <paper-button raised id="edit" on-tap="edit">Edit</paper-button>
                <paper-button note="[[note]]" on-tap="delete">Delete</paper-button>
                <paper-button raised id="private" on-tap="private">Mark as private</paper-button>
            </paper-card>
        </template>
        <div class="notes">
            <template is="dom-repeat" items="[[persistedData]]" as="note">
                <!--
        <na-note
            id$="[[note.$key]]"
            title="[[note.title]]"
            body="[[note.body]]"
            on-tap="edit">
        </na-note>
-->
            </template>
        </div>
        <firebase-document id="document" app-name="notes" path="[[editableNoteId]]" data="{{editableNote}}"> </firebase-document>
    </template>
    <script>
        Polymer({
            is: 'my-notes'
            , properties: {
                notes: {
                    type: Object
                }
                , newNote: {
                    type: Object
                    , value: function () {
                        return {
                            content: ""
                            , healthDiscussed: false
                            , movementDiscussed: false
                            , movementFelt: false
                            , bloodPressure: ""
                            , gestationWeeks: ""
                            , gestationDays: ""
                            , appointmentDate: ""
                        }
                    }
                }
            }
            , add: function () {
                //pushing content object
                this.$.query.ref.push(this.newNote);
                //clearing field for next input
                this.newNote = {
                    content: ""
                    , healthDiscussed: false
                    , movementDiscussed: false
                    , movementFelt: false
                    , bloodPressure: ""
                    , gestationWeeks: ""
                    , gestationDays: ""
                    , appointmentDate: ""
                };
            }
            , delete: function (e) {
                var key = e.currentTarget.note.$key;
                this.$.query.ref.child(key).remove();
            }
            , edit: function (e) {
                var key = e.currentTarget.note.$key;
            }
        });
        new Polymer.IronMeta({
            type: 'validator'
            , key: 'this-year-validator'
            , value: {
                validate: function (value) {
                    var currentYear = new Date().getFullYear();
                    return new Date(value).getFullYear() === currentYear;
                }
            }
        });
    </script>
</dom-module>